<?xml version="1.0" encoding="UTF-8"?>
<launch>
    <!-- Launch arguments -->
    <!-- SAM and sensor arguments -->
    <arg name="search_text" default="[a door]" doc="Text prompt for SAM"/>
    <arg name="image_topic" default="/camera/color/image_raw" doc="RGB image topic"/>
    <arg name="point_cloud_topic" default="/camera/depth_registered/points" doc="Point cloud topic"/>
    <arg name="camera_frame" default="camera_link" doc="Camera frame ID"/>

    <!-- MAVROS arguments -->
    <arg name="fcu_url" default="/dev/ttyACM0:921600" doc="FCU connection URL"/>
    <arg name="gcs_url" default="" doc="GCS URL"/>
    <arg name="tgt_system" default="1" doc="Target system ID"/>
    <arg name="tgt_component" default="1" doc="Target component ID"/>

    <!-- Visualization -->
    <arg name="start_rviz" default="true" doc="Start RViz"/>
    <arg name="rviz_config" default="$(find sam_fp)/rviz/traverse.rviz" doc="RViz config file"/>

    <!-- Launch RealSense camera -->
    <include file="$(find realsense2_camera)/launch/rs_rgbd.launch">
        <!-- RealSense camera parameters -->
    </include>

    <!-- Launch MAVROS -->
    <include file="$(find mavros)/launch/px4.launch">
        <arg name="fcu_url" value="$(arg fcu_url)"/>
        <arg name="gcs_url" value="$(arg gcs_url)"/>
        <arg name="tgt_system" value="$(arg tgt_system)"/>
        <arg name="tgt_component" value="$(arg tgt_component)"/>
    </include>

    <!-- Include base launch file -->
    <include file="$(find sam_fp)/launch/base.launch">
        <arg name="search_text" value="$(arg search_text)"/>
        <arg name="image_topic" value="$(arg image_topic)"/>
        <arg name="point_cloud_topic" value="$(arg point_cloud_topic)"/>
        <arg name="camera_frame" value="$(arg camera_frame)"/>
        <arg name="start_rviz" value="false"/>
        <arg name="rviz_config" value="$(arg rviz_config)"/>
    </include>

    <!-- Autonomous Navigation -->
    <!-- Door traverse node -->
    <node name="door_traverse_node" pkg="sam_fp" type="mavros.py" output="screen">
        <!-- Parameters inherited from mavros.py -->
    </node>

    <!-- TF tree configuration -->
    <!-- Static transform from base_link to camera -->
    <node pkg="tf" type="static_transform_publisher" name="camera_transform"
          args="0.1 0 0.05 0 0 0 base_link $(arg camera_frame) 100"/>

    <!-- Static transform from map to odom (if needed) -->
    <node pkg="tf" type="static_transform_publisher" name="map_transform"
          args="0 0 0 0 0 0 map odom 100"/>

    <!-- RViz with custom config for autonomous traverse -->
    <node if="$(arg start_rviz)"
          name="rviz" pkg="rviz" type="rviz"
          args="-d $(arg rviz_config)"
          output="screen"/>

    <!-- Optional: Add diagnostics aggregator for system health monitoring -->
    <node pkg="diagnostic_aggregator" type="aggregator_node" name="diagnostic_aggregator">
        <rosparam command="load" file="$(find sam_fp)/config/diagnostics.yaml"/>
    </node>
</launch>
